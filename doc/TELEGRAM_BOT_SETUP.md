# ü§ñ Telegram Bot Integration

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram Bot API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Laravel 12
- PHP 8.2+
- Telegram Bot Token
- OpenAI API Key

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
composer install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª `.env`:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# OpenAI
OPEN_AI_KEY=your_openai_api_key_here
```

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram Bot Token

1. –ù–∞–π–¥–∏—Ç–µ @BotFather –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ `.env` —Ñ–∞–π–ª

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
php artisan telegram:bot set-webhook --url=https://yourdomain.com/telegram/webhook
```

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok
ngrok http 8000

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook —Å URL –æ—Ç ngrok
php artisan telegram:bot set-webhook --url=https://your-ngrok-url.ngrok.io/telegram/webhook
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
php artisan telegram:bot info

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
php artisan telegram:bot set-webhook --url=https://yourdomain.com/telegram/webhook

# –£–¥–∞–ª–∏—Ç—å webhook
php artisan telegram:bot delete-webhook

# –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ webhook
php artisan telegram:bot webhook-info

# –û—á–∏—Å—Ç–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–µ—Å—Å–∏–∏
php artisan sessions:clean
```

### –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

- `/start` - –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –±–æ—Ç–æ–º
- `/help` - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
- `/ask` - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∫–æ—Ç—É –•–∞—Ä–∏—Ç–æ–Ω—É (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º)
- `/status` - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
- –õ—é–±–æ–π —Ç–µ–∫—Å—Ç - –ü–æ–ª—É—á–∏—Ç—å AI-–æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
app/
‚îú‚îÄ‚îÄ Console/Commands/
‚îÇ   ‚îú‚îÄ‚îÄ TelegramBotCommand.php          # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ CleanUserSessionsCommand.php    # –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π
‚îú‚îÄ‚îÄ Http/Controllers/
‚îÇ   ‚îî‚îÄ‚îÄ TelegramWebhookController.php   # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook'–æ–≤
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ UserSession.php                 # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π
‚îî‚îÄ‚îÄ Services/
    ‚îú‚îÄ‚îÄ OpenAIService.php               # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI
    ‚îú‚îÄ‚îÄ TelegramBotService.php          # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram API
    ‚îî‚îÄ‚îÄ UserSessionService.php          # –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏

routes/
‚îî‚îÄ‚îÄ web.php                             # –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è webhook'–æ–≤

resources/views/
‚îî‚îÄ‚îÄ telegram.blade.php                  # –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º
```

## üîß –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### TelegramBotService

–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API:

- `sendMessage()` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `getMe()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ
- `setWebhook()` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
- `deleteWebhook()` - –£–¥–∞–ª–µ–Ω–∏–µ webhook
- `getWebhookInfo()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook
- `sendKeyboardMessage()` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
- `sendInlineKeyboardMessage()` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π

### TelegramWebhookController

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–∏—Ö webhook'–æ–≤ –æ—Ç Telegram:

- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (`/start`, `/help`, `/ask`, `/status`)
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/ask`
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ callback query (inline –∫–Ω–æ–ø–∫–∏)

### OpenAIService

–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API:

- `ask()` - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
- `generatePromptWithSimilarQuestions()` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
- `findSimilarQuestions()` - –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### UserSessionService

–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–µ—Å—Å–∏—è–º–∏:

- `getSession()` - –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `setState()` - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `clearState()` - –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `isInState()` - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- `cleanExpiredSessions()` - –û—á–∏—Å—Ç–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–µ—Å—Å–∏–∏

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `storage/logs/laravel.log`:

- –í—Ö–æ–¥—è—â–∏–µ webhook'—ã
- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û—à–∏–±–∫–∏ API
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### CSRF Protection

Webhook –º–∞—Ä—à—Ä—É—Ç –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ CSRF –∑–∞—â–∏—Ç—ã –≤ `bootstrap/app.php`:

```php
$middleware->validateCsrfTokens(except: [
    'telegram/webhook',
]);
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Telegram Bot Token
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è OpenAI API Key
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```bash
php artisan serve
```

2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è —Ç—É–Ω–Ω–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
ngrok http 8000
```

3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook:
```bash
php artisan telegram:bot set-webhook --url=https://your-ngrok-url.ngrok.io/telegram/webhook
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook —Å HTTPS URL:
```bash
php artisan telegram:bot set-webhook --url=https://yourdomain.com/telegram/webhook
```

3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:
```bash
tail -f storage/logs/laravel.log
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞

```bash
php artisan telegram:bot info
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

```bash
php artisan telegram:bot webhook-info
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook

```bash
curl -X POST http://localhost:8000/telegram/webhook \
  -H "Content-Type: application/json" \
  -d '{"update_id":123,"message":{"message_id":1,"from":{"id":123456,"first_name":"Test"},"chat":{"id":123456},"text":"/start"}}'
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
tail -f storage/logs/laravel.log
```

## üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–î–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: `http://yourdomain.com/telegram`

–°–æ–¥–µ—Ä–∂–∏—Ç:
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞
- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- –°—Ç–∞—Ç—É—Å webhook

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `storage/logs/laravel.log`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å webhook: `php artisan telegram:bot webhook-info`
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞) 